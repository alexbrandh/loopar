<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Preload critical scripts -->
  <link rel="preload" href="https://aframe.io/releases/1.5.0/aframe.min.js" as="script" crossorigin>
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js" as="script" crossorigin>
  <style>
    * { margin: 0; padding: 0; }
    html, body { overflow: hidden; width: 100%; height: 100%; background: #000; }
    
    /* Loading screen with camera preview */
    #loading-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-family: -apple-system, sans-serif;
    }
    #loading-screen.hidden { display: none; }
    
    #camera-preview {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      opacity: 0.3;
    }
    
    .loading-content {
      position: relative;
      z-index: 1;
      text-align: center;
      color: white;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-text {
      font-size: 16px;
      opacity: 0.9;
    }
    .loading-percent {
      font-size: 14px;
      opacity: 0.6;
      margin-top: 8px;
    }
    
    #back-btn {
      position: fixed;
      top: max(16px, env(safe-area-inset-top));
      left: 16px;
      width: 48px;
      height: 48px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      cursor: pointer;
    }
    
    #status {
      position: fixed;
      bottom: max(24px, env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      font-family: -apple-system, sans-serif;
    }
    #status.found { background: rgba(34,197,94,0.9); }
    #status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #fbbf24;
    }
    #status.found .dot { background: #fff; }
    #status span { color: #fff; font-size: 14px; }
  </style>
</head>
<body>
  <!-- Loading screen shown immediately -->
  <div id="loading-screen">
    <video id="camera-preview" autoplay muted playsinline></video>
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">Cargando experiencia AR...</div>
      <div class="loading-percent" id="loading-percent">Iniciando c√°mara...</div>
    </div>
  </div>
  
  <button id="back-btn" onclick="history.back()">
    <svg width="24" height="24" fill="none" stroke="#fff" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
  </button>
  <div id="status">
    <div class="dot"></div>
    <span>Buscando imagen...</span>
  </div>
  <script>
    const loadingPercent = document.getElementById('loading-percent');
    const cameraPreview = document.getElementById('camera-preview');
    const loadingScreen = document.getElementById('loading-screen');
    
    let scriptsLoaded = false;
    let dataLoaded = false;
    let postcard = null;
    let videoUrl = null;
    let targetUrl = null;
    let planeWidth = 1;
    let planeHeight = 0.5625;
    
    // Start camera preview immediately
    async function startCameraPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        cameraPreview.srcObject = stream;
        loadingPercent.textContent = 'C√°mara lista...';
        console.log('üì∑ Camera preview started');
      } catch (e) {
        console.log('Camera preview not available:', e);
        loadingPercent.textContent = 'Cargando...';
      }
    }
    
    // Load scripts dynamically
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    
    async function loadScripts() {
      const startTime = Date.now();
      
      loadingPercent.textContent = 'Cargando A-Frame...';
      await loadScript('https://aframe.io/releases/1.5.0/aframe.min.js');
      console.log('‚è±Ô∏è A-Frame loaded in', Date.now() - startTime, 'ms');
      
      loadingPercent.textContent = 'Cargando MindAR...';
      await loadScript('https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js');
      console.log('‚è±Ô∏è MindAR loaded in', Date.now() - startTime, 'ms');
      
      // Register components after scripts load
      registerComponents();
      scriptsLoaded = true;
      loadingPercent.textContent = 'Preparando AR...';
      
      checkReady();
    }
    
    // Fetch postcard data
    async function loadData() {
      const urlParams = new URLSearchParams(window.location.search);
      const postcardId = urlParams.get('id');
      
      if (!postcardId) {
        throw new Error('No postcard ID');
      }
      
      const response = await fetch('/api/postcards/' + postcardId);
      const result = await response.json();
      postcard = result.data;
      
      if (!postcard?.video_url) {
        throw new Error('No video URL');
      }
      
      videoUrl = postcard.video_url;
      targetUrl = `/api/ar/mind-target/${postcard.user_id}/${postcard.id}`;
      
      // Get video dimensions
      await new Promise((resolve) => {
        const preloadVideo = document.createElement('video');
        preloadVideo.crossOrigin = 'anonymous';
        preloadVideo.muted = true;
        preloadVideo.playsInline = true;
        preloadVideo.preload = 'metadata';
        
        preloadVideo.onloadedmetadata = () => {
          const aspectRatio = preloadVideo.videoWidth / preloadVideo.videoHeight;
          if (aspectRatio >= 1) {
            planeWidth = 1;
            planeHeight = 1 / aspectRatio;
          } else {
            planeWidth = aspectRatio;
            planeHeight = 1;
          }
          console.log('üìê Video aspect ratio:', aspectRatio);
          resolve();
        };
        preloadVideo.onerror = () => resolve(); // Use defaults
        preloadVideo.src = videoUrl;
      });
      
      dataLoaded = true;
      checkReady();
    }
    
    function registerComponents() {
      AFRAME.registerComponent('video-texture', {
        schema: { src: { type: 'selector' } },
        init: function() {
          this.video = this.data.src;
          if (this.video) {
            this.texture = new THREE.VideoTexture(this.video);
            this.texture.minFilter = THREE.LinearFilter;
            this.texture.magFilter = THREE.LinearFilter;
            const mesh = this.el.getObject3D('mesh');
            if (mesh) {
              mesh.material = new THREE.MeshBasicMaterial({
                map: this.texture,
                side: THREE.DoubleSide
              });
            }
          }
        },
        tick: function() {
          if (this.texture && this.video?.readyState >= 2) {
            this.texture.needsUpdate = true;
          }
        }
      });

      AFRAME.registerComponent('target-handler', {
        init: function() {
          this.video = document.querySelector('#vid');
          const status = document.querySelector('#status');
          const statusText = status?.querySelector('span');
          
          this.el.addEventListener('targetFound', () => {
            console.log('Target found!');
            if (status) status.classList.add('found');
            if (statusText) statusText.textContent = '¬°Imagen detectada!';
            if (this.video) {
              this.video.currentTime = 0;
              this.video.muted = true;
              this.video.play().then(() => {
                this.video.muted = false;
              }).catch(e => {
                console.log('Play error:', e);
                this.video.muted = true;
                this.video.play();
              });
            }
          });
          this.el.addEventListener('targetLost', () => {
            console.log('Target lost');
            if (status) status.classList.remove('found');
            if (statusText) statusText.textContent = 'Buscando imagen...';
            if (this.video) this.video.pause();
          });
        }
      });
    }
    
    function checkReady() {
      if (!scriptsLoaded || !dataLoaded) return;
      
      console.log('‚úÖ All ready, creating AR scene');
      
      // Stop camera preview
      if (cameraPreview.srcObject) {
        cameraPreview.srcObject.getTracks().forEach(t => t.stop());
      }
      
      // Remove loading screen completely from DOM
      loadingScreen.remove();
      
      // Create AR scene
      const sceneContainer = document.createElement('div');
      sceneContainer.innerHTML = `
        <a-scene
          mindar-image="imageTargetSrc: ${targetUrl}; autoStart: true;"
          color-space="sRGB"
          renderer="colorManagement: true, physicallyCorrectLights"
          vr-mode-ui="enabled: false"
          device-orientation-permission-ui="enabled: false"
        >
          <a-assets>
            <video id="vid" src="${videoUrl}" crossorigin="anonymous" loop muted playsinline></video>
          </a-assets>
          
          <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
          
          <a-entity mindar-image-target="targetIndex: 0" target-handler>
            <a-plane position="0 0 0" width="${planeWidth}" height="${planeHeight}" video-texture="src: #vid" material="shader: flat"></a-plane>
          </a-entity>
        </a-scene>
      `;
      document.body.appendChild(sceneContainer);
    }
    
    // Start everything in parallel
    window.addEventListener('DOMContentLoaded', async () => {
      const startTime = Date.now();
      console.log('üöÄ Starting parallel load...');
      
      try {
        // Run all in parallel
        await Promise.all([
          startCameraPreview(),
          loadScripts(),
          loadData()
        ]);
        
        console.log('‚è±Ô∏è Total load time:', Date.now() - startTime, 'ms');
      } catch (error) {
        console.error('Load error:', error);
        document.body.innerHTML = '<div style="color:white;padding:20px;">Error: ' + error.message + '</div>';
      }
    });
  </script>
</body>
</html>
